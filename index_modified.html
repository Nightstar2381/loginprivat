<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เข้าสู่ระบบ | สมัครสมาชิก - ระบบความปลอดภัยสูง</title>
  <!-- (สไตล์เดิมทั้งหมดคงไว้ไม่เปลี่ยนเพื่อประหยัดพื้นที่) -->
</head>
<body>
  <!-- (HTML เดิมทั้งหมดคงไว้ เช่น ฟอร์มล็อกอินและสมัครสมาชิก) -->

  <script>
    // เพิ่มฟังก์ชัน simulateLogin ที่เชื่อม Google Sheets
    function simulateLogin(email, password, captchaAnswer, twoFactorCode) {
      return new Promise(async (resolve) => {
        if (isLocked) {
          resolve({ success: false, message: 'บัญชีถูกล็อกชั่วคราว กรุณารอให้หมดเวลา' });
          return;
        }

        if (loginAttempts >= 3 && rateLimitDelay > Date.now()) {
          showRateLimit();
          resolve({ success: false, message: 'กรุณารอสักครู่ก่อนพยายามอีกครั้ง' });
          return;
        }

        if (loginAttempts >= 2) {
          document.getElementById('loginCaptcha').style.display = 'block';
          if (!verifyCaptcha(captchaAnswer, loginCaptcha.answer)) {
            resolve({ success: false, message: 'CAPTCHA ไม่ถูกต้อง' });
            return;
          }
        }

        try {
          const response = await fetch("https://script.google.com/macros/s/AKfycbzMXG6zN7d2Y7Y4dLDJksEIQjK8yD4BOu_4jdIZxpsVqNRsCEX6HnSurocRvddE2y2X/exec", {
            method: "POST",
            body: JSON.stringify({
              type: "login",
              email: email,
              password: password
            })
          });

          const result = await response.text();

          if (result === "LOGIN_SUCCESS") {
            loginAttempts = 0;
            updateLoginAttempts();
            resolve({
              success: true,
              message: "เข้าสู่ระบบสำเร็จ!",
              redirect: true
            });
          } else if (result === "INVALID_CREDENTIALS") {
            loginAttempts++;
            updateLoginAttempts();
            if (loginAttempts >= 3) rateLimitDelay = Date.now() + 30000;
            if (loginAttempts >= maxLoginAttempts) {
              lockAccount();
              resolve({ success: false, message: 'บัญชีถูกล็อกเนื่องจากพยายามเข้าสู่ระบบผิดหลายครั้ง' });
            } else {
              resolve({ success: false, message: `อีเมลหรือรหัสผ่านไม่ถูกต้อง (เหลือ ${maxLoginAttempts - loginAttempts} ครั้ง)` });
            }
          } else {
            resolve({ success: false, message: 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ' });
          }

        } catch (err) {
          resolve({ success: false, message: 'ไม่สามารถเชื่อมต่อกับระบบได้' });
        }
      });
    }

    // เปลี่ยนเนื้อหาการจัดการล็อกอินให้ redirect หากสำเร็จ
    document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
      e.preventDefault();
      const button = e.target.querySelector('.btn');
      const formData = new FormData(e.target);

      button.classList.add('loading');
      button.textContent = '';

      try {
        const result = await simulateLogin(
          formData.get('email'),
          formData.get('password'),
          document.getElementById('captchaAnswer').value,
          document.getElementById('twoFactorCode').value
        );

        if (result.success) {
          if (result.redirect) {
            window.location.href = "https://nightstar2381.github.io/dasbordui/";
            return;
          }
          if (result.requires2FA) {
            document.getElementById('twoFactorContainer').style.display = 'block';
            showMessage('success', 'กรุณาใส่รหัส 2FA เพื่อเข้าสู่ระบบ', 'login');
          } else {
            showMessage('success', result.message, 'login');
          }
        } else {
          showMessage('error', result.message, 'login');
          loginCaptcha = generateCaptcha();
          document.getElementById('captchaQuestion').textContent = `กรุณาแก้โจทย์: ${loginCaptcha.question}`;
          document.getElementById('captchaAnswer').value = '';
        }
      } catch (error) {
        showMessage('error', 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ', 'login');
      }

      button.classList.remove('loading');
      button.textContent = 'เข้าสู่ระบบ';
    });
  </script>
</body>
</html>
